---
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import type { MarkdownHeading } from "astro";

interface Props {
  frontmatter: Record<string, any>;
  headings?: MarkdownHeading[];
}

const { frontmatter, headings = [] } = Astro.props;

// Precompute TOC numbers (h1 + h2 only)
let h1Counter = 0;
let h2Counter = 0;
const tocHeadings = headings
  .filter(({ depth }) => depth >= 1 && depth <= 2)
  .map((heading) => {
    if (heading.depth === 1) {
      h1Counter++;
      h2Counter = 0;
      return { ...heading, number: `${h1Counter}.` };
    } else {
      h2Counter++;
      return { ...heading, number: `${h1Counter}.${h2Counter}` };
    }
  });
---

<BaseLayout title={frontmatter.title}>
  <div class="blog-post-container-wrapper animate-on-load">
    <div class="blog-post-container">
      <div class="tag-wrapper">
        TAGS:
        {
          frontmatter.tags.map((tag: string, i: number) => (
            <span class="tag">
              {tag.toUpperCase()}
              {i !== frontmatter.tags.length - 1 ? ", " : ""}
            </span>
          ))
        }
      </div>
      <h1 class="post-title">{frontmatter.title}</h1>

      <div class="intro">
        <div class="me">
          <img src="/icons/logo_dark.svg" alt="" class="me-dark" />
          <img src="/icons/logo_light.svg" alt="" class="me-light" />
        </div>
        <div class="me-info">
          <p class="me-name">Xyroton</p>
          <div class="me-date">
            <FormattedDate date={frontmatter.pubDate} />
            {
              frontmatter.updatedDate && (
                <>
                  <span class="dot">Â·</span>
                  <span class="edit">Updated:</span>
                  <span class="edit">
                    <FormattedDate
                      date={frontmatter.updatedDate}
                      format="long"
                    />
                  </span>
                </>
              )
            }
          </div>
        </div>
      </div>

      <div class="hero-image">
        {
          frontmatter.image.url && (
            <img src={frontmatter.image.url} alt={frontmatter.image.alt} />
          )
        }
      </div>

      <!-- TOC -->
      {
        tocHeadings.length > 0 && (
          <details class="toc">
            <summary class="toc-toggle">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="toc-icon"
              >
                <path d="M16 12H3" />
                <path d="M16 18H3" />
                <path d="M16 6H3" />
                <path d="M21 12h.01" />
                <path d="M21 18h.01" />
                <path d="M21 6h.01" />
              </svg>
              <span>Table of Contents</span>
              <span class="toc-count">({tocHeadings.length})</span>
              <svg
                class="chevron"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </summary>

            <ul class="toc-list">
              {tocHeadings.map((heading) => (
                <li class={`depth-${heading.depth}`}>
                  <a href={`#${heading.slug}`}>
                    {heading.number} {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </details>
        )
      }

      <div class="blog-content">
        <slot />
      </div>
    </div>
  </div>

  <!-- GDPR-Compliant Giscus Integration -->
  <div class="comment-section">
    <button id="load-comments" class="btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="comment-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path
          d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"
        ></path>
        <path d="M7 11h10"></path>
        <path d="M7 15h6"></path>
        <path d="M7 7h8"></path>
      </svg>
      <span>Load Comments</span>
    </button>
    <p class="comment-consent-note">
      Comments are powered by Giscus, which may load third-party cookies. By
      clicking "Load Comments", you agree to GitHub's
      <a
        href="https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement"
        target="_blank"
        rel="noopener noreferrer">Privacy Policy</a
      >.
    </p>
  </div>

  <script is:inline>
    function loadGiscus() {
      if (document.querySelector("iframe.giscus-frame")) return;

      const script = document.createElement("script");
      script.src = "https://giscus.app/client.js";
      script.async = true;
      script.crossOrigin = "anonymous";
      script.setAttribute("data-repo", "xyroton/xyroton.github.io");
      script.setAttribute("data-repo-id", "R_kgDOO0t3rg");
      script.setAttribute("data-category", "Blog Comments");
      script.setAttribute("data-category-id", "DIC_kwDOO0t3rs4CsPmf");
      script.setAttribute("data-mapping", "pathname");
      script.setAttribute("data-strict", "0");
      script.setAttribute("data-reactions-enabled", "1");
      script.setAttribute("data-emit-metadata", "0");
      script.setAttribute("data-input-position", "bottom");
      script.setAttribute("data-lang", "en");
      script.setAttribute(
        "data-theme",
        document.documentElement.getAttribute("theme") === "light"
          ? "light"
          : "dark",
      );

      document.querySelector(".comment-section").appendChild(script);
      document.getElementById("load-comments")?.remove();
      document.querySelector(".comment-consent-note")?.remove();
    }

    if (localStorage.getItem("giscus-consent") === "true") {
      loadGiscus();
    } else {
      document
        .getElementById("load-comments")
        ?.addEventListener("click", () => {
          localStorage.setItem("giscus-consent", "true");
          loadGiscus();
        });
    }

    new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        if (mutation.attributeName === "theme") {
          const giscusFrame = document.querySelector("iframe.giscus-frame");
          if (giscusFrame?.contentWindow) {
            giscusFrame.contentWindow.postMessage(
              {
                giscus: {
                  setConfig: {
                    theme:
                      document.documentElement.getAttribute("theme") === "light"
                        ? "light"
                        : "dark",
                  },
                },
              },
              "https://giscus.app",
            );
          }
        }
      }
    }).observe(document.documentElement, { attributes: true });

    // External links new tab
    document.addEventListener("DOMContentLoaded", () => {
      const blogPostContainer = document.querySelector(".blog-post-container");
      if (!blogPostContainer) return;

      blogPostContainer.querySelectorAll("a").forEach((link) => {
        if (
          !link.hasAttribute("target") &&
          link.href &&
          !link.href.startsWith("#") &&
          !link.href.startsWith(window.location.origin)
        ) {
          link.setAttribute("target", "_blank");
          link.setAttribute("rel", "noopener noreferrer");
        }
      });
    });
    document.querySelectorAll(".toc-list a").forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute("href"));
        if (target) {
          const toc = link.closest("details");
          const summary = toc?.querySelector("summary");
          const tocHeight = toc ? toc.offsetHeight : 0;
          const summaryHeight = summary ? summary.offsetHeight : 0;
          const extraMargin = 70; // optional small buffer
          const top =
            target.getBoundingClientRect().top +
            window.scrollY -
            tocHeight +
            summaryHeight -
            extraMargin;
          window.scrollTo({ top, behavior: "smooth" });
        }

        // Close TOC on mobile
        const details = link.closest("details");
        if (details) details.removeAttribute("open");
      });
    });
  </script>
</BaseLayout>

<style>
  .edit {
    font-style: italic;
  }

  .intro {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .me-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.3;
    padding-bottom: 0.4rem;
  }
  .me-name {
    font-family: "Inter-SemiBold";
    font-size: 1rem;
    margin: 0;
  }
  .me-date {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0;
  }

  .me-light,
  .me-dark {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: none;
  }
  html[theme="light"] .me-light {
    display: block;
  }
  html[theme="dark"] .me-dark {
    display: block;
  }

  .me {
    background-color: var(--bg-light);
    width: 45px;
    height: 45px;
    padding: 4px;
    border-radius: 50px;
    border: 1px solid var(--bg-extra-light);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
  }

  .blog-post-container {
    margin: auto;
    max-width: 700px;
  }
  .comment-section {
    max-width: 720px;
    margin: 0 auto;
    border-radius: 5px;
    margin-top: 50px;
    background-color: var(--bg);
    text-align: center;
  }

  .comment-consent-note {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.75rem;
  }

  .comment-consent-note a {
    color: var(--secondary);
    text-decoration: underline;
  }

  .btn svg.comment-icon {
    vertical-align: middle;
  }

  .btn {
    background-color: var(--primary);
    color: var(--bg);
    border: none;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    font-family: "Inter-SemiBold";
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-align: center;
  }
  /* .btn:hover {
    background-color: var(--tertiary);
  } */

  .post-title {
    font-size: 2.5rem;
    line-height: 1.1;
    font-weight: bold;
    margin-bottom: 0.9rem;
    font-family: "Inter-ExtraBold";
  }
  .tag-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
    font-family: "Inter-SemiBold";
    font-size: 0.7rem;
  }
  .tag {
    display: inline-flex;
    align-items: center;
    color: var(--secondary);
    gap: 0.2em;
  }
  .hero-image img {
    display: block;
    margin: 0 auto;
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: var(--box-shadow);
    margin-top: 2rem;
    margin-bottom: 0rem;
  }

  /* TOC Styles */
  .toc {
    margin: 2rem 0;
    border: 1px solid var(--bg-extra-light);
    border-radius: 8px;
    background: var(--bg-light);
    overflow: hidden;
  }
  .toc-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    font-family: "Inter-SemiBold";
    font-size: 1rem;
    user-select: none;
  }
  .toc-toggle::-webkit-details-marker {
    display: none;
  }
  .toc-toggle::marker {
    content: "";
  }
  .toc-count {
    margin-left: auto;
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  .chevron {
    margin-left: 0.5rem;
    transition: transform 0.3s ease;
  }
  details[open] .chevron {
    transform: rotate(180deg);
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0 1rem 0.5rem 1rem;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition:
      max-height 0.35s ease,
      opacity 0.25s ease;
  }
  details[open] .toc-list {
    max-height: 500px;
    opacity: 1;
  }

  .toc-list li.depth-1 a {
    color: var(--text); /* normal foreground for h1 */
  }

  .toc-list li.depth-2 a {
    color: var(--text-muted); /* muted color for h2 */
    font-weight: normal;
    margin-left: 1.5rem;
  }
</style>
